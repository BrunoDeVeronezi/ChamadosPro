import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Checkbox } from "@/components/ui/checkbox";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Download, CheckCircle2, Clock, TrendingUp, DollarSign, Clock3, MessageCircle, X } from "lucide-react";
import { Skeleton } from "@/components/ui/skeleton";
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { unmaskPhone } from "@/lib/masks";
import { format, differenceInMinutes, differenceInCalendarDays } from "date-fns";
import { ptBR } from "date-fns/locale";
import { useMemo, useState } from "react";

interface Receivable {
  id: string;
  clientName: string;
  amount: number;
  dueDate: Date;
  status: "pending" | "overdue" | "paid";
}

interface FinancialDashboardProps {
  cashFlowData: { date: string; value: number }[];
  receivables: Receivable[];
  loading?: boolean;
  summaryOverrides?: {
    receivedThisMonth: number;
    toReceiveTotal: number;
    pendingThisMonth: number;
    billingThisMonth: number;
  };
  completedTickets?: any[];
}

const statusConfig = {
  pending: { label: "Pendente", variant: "outline" as const },
  overdue: { label: "Atrasado", variant: "destructive" as const },
  paid: { label: "Pago", variant: "secondary" as const },
};

const normalizeStatus = (status?: string) => (status || "").trim().toUpperCase();

export function FinancialDashboard({
  cashFlowData,
  receivables,
  loading,
  summaryOverrides,
  completedTickets = [],
}: FinancialDashboardProps) {
  const [showBillingDetail, setShowBillingDetail] = useState(false);
  const [showPendingDetail, setShowPendingDetail] = useState(false);
  const [showPendingCards, setShowPendingCards] = useState(false);
  const [selectedTicket, setSelectedTicket] = useState<any | null>(null);
  const [dialogOpen, setDialogOpen] = useState(false);
  const [selectedPending, setSelectedPending] = useState<Set<string>>(new Set());
  const [selectedClientFilter, setSelectedClientFilter] = useState<string>("all");
  const [pendingFilterType, setPendingFilterType] = useState<"all" | "overdue">("all");

  const formatCurrency = (value: number) =>
    new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" }).format(value);

  const formatDate = (value?: string | Date | null) => {
    if (!value) return "Sem data";
    const d = value instanceof Date ? value : new Date(value);
    return isNaN(d.getTime()) ? "Data inválida" : format(d, "dd/MM/yyyy", { locale: ptBR });
  };

  const formatDateTime = (value?: string | Date | null) => {
    if (!value) return "Sem horário";
    const d = value instanceof Date ? value : new Date(value);
    return isNaN(d.getTime()) ? "Data inválida" : format(d, "dd/MM/yyyy HH:mm", { locale: ptBR });
  };

  const calcHours = (start?: string, end?: string) => {
    if (start && end) {
      const minutes = differenceInMinutes(new Date(end), new Date(start));
      return (minutes / 60).toFixed(2);
    }
    return "0.00";
  };

  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const currentMonth = now.getMonth();
  const currentYear = now.getFullYear();

  const normalizeRecordStatus = (status: string | undefined): boolean => {
    if (!status) return false;
    const statusUpper = status.toString().toUpperCase();
    return statusUpper === "PAID" || statusUpper === "PAGO";
  };

  const isOverdue = useMemo(() => {
    const overdueSet = new Set<string>();
    receivables.forEach((r) => {
      if (normalizeRecordStatus(r.status) || r.status === "paid") return;
      const dueDate = r.dueDate instanceof Date ? r.dueDate : new Date(r.dueDate);
      if (isNaN(dueDate.getTime())) return;
      const d = new Date(dueDate.getFullYear(), dueDate.getMonth(), dueDate.getDate());
      if (d < today) overdueSet.add(r.id);
    });
    return overdueSet;
  }, [receivables, today]);

  const pendingThisMonth = useMemo(() => {
    return receivables.filter((r) => {
      if (normalizeRecordStatus(r.status) || r.status === "paid") return false;
      const d = r.dueDate instanceof Date ? r.dueDate : new Date(r.dueDate);
      if (isNaN(d.getTime())) return false;
      return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
    });
  }, [receivables, currentMonth, currentYear]);

  const overdueList = useMemo(() => receivables.filter((r) => isOverdue.has(r.id)), [receivables, isOverdue]);

  const filteredPendingList = useMemo(
    () => (pendingFilterType === "overdue" ? overdueList : pendingThisMonth),
    [pendingFilterType, overdueList, pendingThisMonth],
  );

  const clientsWithPending = useMemo(() => {
    const set = new Set<string>();
    filteredPendingList.forEach((r) => set.add(r.clientName));
    return Array.from(set).sort();
  }, [filteredPendingList]);

  const filteredPending = useMemo(() => {
    if (selectedClientFilter === "all") return filteredPendingList;
    return filteredPendingList.filter((r) => r.clientName === selectedClientFilter);
  }, [filteredPendingList, selectedClientFilter]);

  const handleSelectAll = (checked: boolean) => {
    if (checked) {
      setSelectedPending(new Set(filteredPending.map((r) => r.id)));
    } else {
      setSelectedPending(new Set());
    }
  };

  const totalReceivables =
    summaryOverrides?.toReceiveTotal ??
    receivables.filter((r) => r.status !== "paid").reduce((sum, r) => sum + r.amount, 0);

  const totalPaid =
    summaryOverrides?.receivedThisMonth ??
    receivables.filter((r) => r.status === "paid").reduce((sum, r) => sum + r.amount, 0);

  const totalPending =
    summaryOverrides?.pendingThisMonth ??
    receivables.filter((r) => r.status === "pending").reduce((sum, r) => sum + r.amount, 0);

  const totalBilling =
    summaryOverrides?.billingThisMonth ?? cashFlowData[cashFlowData.length - 1]?.value ?? 0;

  const completedCards = useMemo(
    () =>
      (completedTickets || []).filter((t) => {
        const st = normalizeStatus(t.status);
        return st === "COMPLETED" || st === "CONCLUIDO" || st === "CONCLUIDO";
      }),
    [completedTickets],
  );

  const pendingCards = useMemo(() => {
    const cards = (completedTickets || []).filter((t) => {
      const st = normalizeStatus(t.status);
      return st !== "COMPLETED" && st !== "CONCLUIDO" && st !== "CONCLUIDO" && st !== "CANCELLED";
    });

    if (cards.length > 0) return cards;

    return filteredPending.map((r) => ({
      id: r.id,
      client: { name: r.clientName, phone: "" },
      service: { name: "Cobrança pendente", price: r.amount },
      ticketValue: r.amount,
      kmRate: 0,
      kmTotal: 0,
      extraExpenses: 0,
      totalAmount: r.amount,
      scheduledFor: r.dueDate,
      startedAt: null,
      stoppedAt: null,
      paymentDate: r.dueDate,
      status: "PENDING",
    }));
  }, [completedTickets, filteredPending]);

  const receivableBuckets = useMemo(() => {
    const today = new Date();
    let vencido = 0;
    let ate7 = 0;
    let ate30 = 0;
    receivables.forEach((r) => {
      if (r.status === "paid") return;
      const days = differenceInCalendarDays(r.dueDate, today);
      if (days < 0) vencido += r.amount;
      else if (days <= 7) ate7 += r.amount;
      else if (days <= 30) ate30 += r.amount;
    });
    return { vencido, ate7, ate30 };
  }, [receivables]);

  const topPendencias = useMemo(() => {
    const map = new Map<string, number>();
    receivables.forEach((r) => {
      if (r.status === "paid") return;
      map.set(r.clientName, (map.get(r.clientName) ?? 0) + r.amount);
    });
    return Array.from(map.entries())
      .map(([clientName, total]) => ({ clientName, total }))
      .sort((a, b) => b.total - a.total)
      .slice(0, 5);
  }, [receivables]);

    const renderTicketCard = (
    t: any,
    disableClick = false,
    selectable = false,
    isSelected = false,
    onSelectChange?: (next: boolean) => void,
  ) => {
    const base = t.ticketValue ? Number(t.ticketValue) : Number(t.service?.price || 0);
    const km = t.kmRate && t.kmTotal ? Number(t.kmRate) * Number(t.kmTotal) : 0;
    const extras = t.extraExpenses ? Number(t.extraExpenses) : 0;
    const total = t.totalAmount ?? base + km + extras;
    const start = formatDateTime(t.startedAt);
    const stop = formatDateTime(t.stoppedAt);
    const hours = calcHours(t.startedAt, t.stoppedAt);
    const phone = t.client?.phone ? unmaskPhone(t.client.phone) : "";

    const handleWhatsApp = (e?: MouseEvent) => {
      if (e) e.stopPropagation();
      if (!phone) {
        window.alert("Telefone do cliente não informado.");
        return;
      }
      const msg = [
        `Cliente: ${t.client?.name || "Cliente"}`,
        `Serviço: ${t.service?.name || "Serviço"}`,
        `Valor chamado: ${formatCurrency(base)}`,
        `Valor KM: ${formatCurrency(km)}`,
        `Extras: ${formatCurrency(extras)}`,
        `Total: ${formatCurrency(total)}`,
        `Início: ${start}`,
        `Fim: ${stop}`,
        `Duração: ${hours}h`,
        `Vencimento: ${formatDate(t.paymentDate)}`,
      ].join(" | ");
      const url = `https://wa.me/55${phone}?text=${encodeURIComponent(msg)}`;
      window.open(url, "_blank");
    };

    return (
      <Card
        key={t.id}
        className="p-3 sm:p-4 bg-secondary/40 border border-border/60 hover:shadow-md cursor-pointer"
        onClick={() => {
          if (disableClick) return;
          setSelectedTicket(t);
          setDialogOpen(true);
        }}
      >
        <div className="flex items-center justify-between gap-3 mb-2">
          <div className="min-w-0">
            <p className="font-semibold truncate">{t.client?.name || "Cliente"}</p>
            <p className="text-xs text-muted-foreground truncate">
              {t.service?.name || "Serviço"} • {formatDate(t.scheduledFor)}
            </p>
          </div>
          <div className="flex items-center gap-2">
            {selectable && (
              <Checkbox
                checked={isSelected}
                onCheckedChange={(checked) => onSelectChange?.(!!checked)}
                onClick={(e) => e.stopPropagation()}
              />
            )}
            <Badge variant="secondary" className="flex-shrink-0">
              {normalizeStatus(t.status) === "PENDING" ? "Pendente" : "Concluído"}
            </Badge>
          </div>
        </div>

        <div className="grid grid-cols-2 gap-2 sm:gap-2.5 mb-2 text-sm">
          <div>
            <p className="text-muted-foreground text-xs">Valor chamado</p>
            <p className="font-semibold">{formatCurrency(base)}</p>
          </div>
          <div>
            <p className="text-muted-foreground text-xs">Valor KM</p>
            <p className="font-semibold">{formatCurrency(km)}</p>
          </div>
          <div>
            <p className="text-muted-foreground text-xs">Extras</p>
            <p className="font-semibold">{formatCurrency(extras)}</p>
          </div>
        </div>

        <div className="grid grid-cols-3 gap-2 mb-2 text-xs sm:text-sm text-muted-foreground">
          <div className="space-y-1">
            <p className="text-muted-foreground text-[11px] sm:text-xs">Início</p>
            <p className="font-semibold text-foreground">{start}</p>
          </div>
          <div className="space-y-1">
            <p className="text-muted-foreground text-[11px] sm:text-xs">Fim</p>
            <p className="font-semibold text-foreground">{stop}</p>
          </div>
          <div className="space-y-1">
            <p className="text-muted-foreground text-[11px] sm:text-xs">Duração</p>
            <p className="font-semibold flex items-center gap-1 text-foreground">
              <Clock3 className="h-4 w-4" /> {hours}
            </p>
          </div>
        </div>

        <div className="text-xs sm:text-sm mb-2">
          <p className="text-muted-foreground text-[11px] sm:text-xs">Vencimento</p>
          <p className="font-semibold">{formatDate(t.paymentDate)}</p>
        </div>

        <div className="flex items-center justify-between mb-3">
          <span className="text-xs text-muted-foreground">Total</span>
          <span className="text-lg font-bold text-primary">{formatCurrency(total)}</span>
        </div>

        <Button variant="secondary" size="sm" className="w-full justify-center gap-2" onClick={(e) => handleWhatsApp(e)}>
          <MessageCircle className="h-4 w-4" />
          Enviar WhatsApp
        </Button>
      </Card>
    );
  };

  if (loading) {
    return (
      <div className="space-y-6">
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          {[1, 2, 3, 4].map((i) => (
            <Card key={i} className="bg-muted border-0">
              <CardContent className="p-6 space-y-3">
                <Skeleton className="h-4 w-24 bg-white/20" />
                <Skeleton className="h-8 w-32 bg-white/30" />
              </CardContent>
            </Card>
          ))}
        </div>
        <Card>
          <CardContent className="p-6">
            <Skeleton className="h-32 w-full" />
          </CardContent>
        </Card>
        <Card>
          <CardContent className="p-6">
            <Skeleton className="h-32 w-full" />
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <Card className="bg-emerald-500 dark:bg-emerald-600 border-0 text-white">
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-white/80 mb-1">Recebido (MÃªs)</p>
                <p className="text-3xl font-bold">
                  R$ {totalPaid.toLocaleString("pt-BR", { minimumFractionDigits: 2 })}
                </p>
              </div>
              <div className="h-12 w-12 rounded-full bg-white/20 flex items-center justify-center">
                <CheckCircle2 className="h-6 w-6 text-white" />
              </div>
            </div>
          </CardContent>
        </Card>

        <Card
          className="bg-blue-500 dark:bg-blue-600 border-0 text-white cursor-pointer"
          onClick={() => {
            setShowPendingDetail((prev) => {
              if (!prev) {
                setPendingFilterType("all");
                setSelectedPending(new Set());
                setSelectedClientFilter("all");
                setShowPendingCards(false);
              }
              return !prev;
            });
          }}
        >
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-white/80 mb-1">Pendentes (MÃªs)</p>
                <p className="text-3xl font-bold">
                  R$ {totalPending.toLocaleString("pt-BR", { minimumFractionDigits: 2 })}
                </p>
              </div>
              <div className="h-12 w-12 rounded-full bg-white/20 flex items-center justify-center">
                <TrendingUp className="h-6 w-6 text-white" />
              </div>
            </div>
          </CardContent>
        </Card>

        <Card className="bg-amber-500 dark:bg-amber-600 border-0 text-white">
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-white/80 mb-1">A Receber (Total)</p>
                <p className="text-3xl font-bold">
                  R$ {totalReceivables.toLocaleString("pt-BR", { minimumFractionDigits: 2 })}
                </p>
              </div>
              <div className="h-12 w-12 rounded-full bg-white/20 flex items-center justify-center">
                <Clock className="h-6 w-6 text-white" />
              </div>
            </div>
          </CardContent>
        </Card>

        <Card
          className="bg-purple-500 dark:bg-purple-600 border-0 text-white cursor-pointer"
          onClick={() => setShowBillingDetail((prev) => !prev)}
        >
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-white/80 mb-1">Faturamento (MÃªs)</p>
                <p className="text-3xl font-bold">
                  R$ {totalBilling.toLocaleString("pt-BR", { minimumFractionDigits: 2 })}
                </p>
              </div>
              <div className="h-12 w-12 rounded-full bg-white/20 flex items-center justify-center">
                <DollarSign className="h-6 w-6 text-white" />
              </div>
            </div>
          </CardContent>
        </Card>
      </div>

      {showBillingDetail && (
        <Card className="border-primary/20 bg-primary/5">
          <CardHeader>
            <div className="flex items-center justify-between gap-4">
              <div className="flex items-center gap-2">
                <DollarSign className="h-5 w-5 text-primary" />
                <CardTitle className="text-xl font-semibold">Detalhamento de Faturamento (MÃªs)</CardTitle>
              </div>
              <Button variant="ghost" size="sm" onClick={() => setShowBillingDetail(false)}>
                <X className="h-4 w-4" />
              </Button>
            </div>
          </CardHeader>
          <CardContent>
            {completedCards.length === 0 ? (
              <div className="text-center py-8 text-muted-foreground">Nenhum chamado CONCLUIDO encontrado</div>
            ) : (
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">
                {completedCards.map((t: any) => renderTicketCard(t))}
              </div>
            )}
          </CardContent>
        </Card>
      )}

      {showPendingDetail && (
        <Card className="border-primary/20 bg-primary/5">
          <CardHeader>
            <div className="flex items-center justify-between gap-4">
              <div className="flex items-center gap-2">
                <TrendingUp className="h-5 w-5 text-primary" />
                <CardTitle className="text-xl font-semibold">
                  {pendingFilterType === "overdue" ? "A Receber Vencido" : "Pendentes (MÃªs)"}
                </CardTitle>
              </div>
              <Button
                variant="ghost"
                size="sm"
                onClick={() => {
                  setShowPendingDetail(false);
                  setSelectedPending(new Set());
                  setSelectedClientFilter("all");
                  setPendingFilterType("all");
                  setShowPendingCards(false);
                }}
              >
                <X className="h-4 w-4" />
              </Button>
            </div>
          </CardHeader>
          <CardContent>
            {filteredPendingList.length === 0 ? (
              <div className="text-center py-8 text-muted-foreground">
                {pendingFilterType === "overdue" ? "Nenhum registro vencido encontrado" : "Nenhum registro pendente no mÃªs"}
              </div>
            ) : (
              <div className="space-y-4">
                <div className="flex flex-col sm:flex-row gap-3 items-start sm:items-center justify-between pb-4 border-b">
                  <div className="flex flex-col sm:flex-row gap-3 flex-1">
                    <div className="flex items-center gap-2">
                      <label className="text-sm font-medium text-muted-foreground whitespace-nowrap">Cliente:</label>
                      <Select value={selectedClientFilter} onValueChange={setSelectedClientFilter}>
                        <SelectTrigger className="w-[200px]">
                          <SelectValue placeholder="Todos os clientes" />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="all">Todos os clientes</SelectItem>
                          {clientsWithPending.map((clientName) => (
                            <SelectItem key={clientName} value={clientName}>
                              {clientName}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                    </div>

                    <div className="flex items-center gap-2">
                      <Checkbox
                        id="select-all"
                        checked={
                          filteredPending.length > 0 &&
                          selectedPending.size === filteredPending.length &&
                          filteredPending.every((r) => selectedPending.has(r.id))
                        }
                        onCheckedChange={(checked) => handleSelectAll(!!checked)}
                      />
                      <label htmlFor="select-all" className="text-sm font-medium cursor-pointer">
                        Selecionar todos
                      </label>
                      {selectedPending.size > 0 && (
                        <span className="text-sm text-muted-foreground ml-2">
                          ({selectedPending.size} {selectedPending.size === 1 ? "selecionado" : "selecionados"})
                        </span>
                      )}
                    </div>
                  </div>

                  <div className="flex items-center gap-2">
                    <Button variant="outline" size="sm" onClick={() => setShowPendingCards((prev) => !prev)}>
                      {showPendingCards ? "Ver lista" : "Ver cards (WhatsApp)"}
                    </Button>
                    {selectedPending.size > 0 && (
                      <Button onClick={() => handleReceivePayment()} className="w-full sm:w-auto">
                        <CheckCircle2 className="h-4 w-4 mr-2" />
                        {selectedPending.size === 1 ? "Receber valor" : `Receber todos (${selectedPending.size})`}
                      </Button>
                    )}
                  </div>
                </div>

                {!showPendingCards ? (
                  <div className="space-y-2">
                    {filteredPending.map((receivable) => {
                      const isSelected = selectedPending.has(receivable.id);
                      const isOverdueRecord = isOverdue.has(receivable.id);
                      return (
                        <Card
                          key={receivable.id}
                          className={`p-4 hover:bg-accent/50 transition-colors ${
                            isSelected ? "bg-primary/10 border-primary" : ""
                          } ${isOverdueRecord ? "border-red-500 border-2 bg-red-50 dark:bg-red-950/20" : ""}`}
                        >
                          <div className="flex items-center gap-4">
                            <Checkbox
                              id={`pending-${receivable.id}`}
                              checked={isSelected}
                              onCheckedChange={(checked) => {
                                const newSelected = new Set(selectedPending);
                                if (checked) newSelected.add(receivable.id);
                                else newSelected.delete(receivable.id);
                                setSelectedPending(newSelected);
                              }}
                            />
                            <div className="flex-1 flex items-center justify-between gap-4">
                              <div className="flex-1 min-w-0">
                                <div className="flex items-center gap-2 mb-1">
                                  <h4 className={`font-semibold truncate ${isOverdueRecord ? "text-red-600 dark:text-red-400" : ""}`}>
                                    {receivable.clientName}
                                  </h4>
                                  <Badge variant={isOverdueRecord ? "destructive" : "outline"}>
                                    {isOverdueRecord ? "Vencido" : "Pendente"}
                                  </Badge>
                                </div>
                                <p className={`text-sm ${isOverdueRecord ? "text-red-600 dark:text-red-400 font-semibold" : "text-muted-foreground"}`}>
                                  Vencimento: {formatDate(receivable.dueDate)}
                                </p>
                              </div>
                              <div className="text-right">
                                <div className={`text-xl font-bold ${isOverdueRecord ? "text-red-600 dark:text-red-400" : ""}`}>
                                  {formatCurrency(receivable.amount)}
                                </div>
                                {isSelected && (
                                  <Button
                                    size="sm"
                                    variant="ghost"
                                    className="mt-1 text-xs"
                                    onClick={() => handleReceivePayment([receivable.id])}
                                  >
                                    Receber
                                  </Button>
                                )}
                              </div>
                            </div>
                          </div>
                        </Card>
                      );
                    })}
                  </div>
                ) : (
                  <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">
                    {pendingCards.map((t: any) => renderTicketCard(t))}
                  </div>
                )}
              </div>
            )}
          </CardContent>
        </Card>
      )}

      <Card>
        <CardHeader>
          <CardTitle className="text-xl font-semibold">A receber por vencimento</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
            <Card className="bg-red-500/10 border-red-500/30">
              <CardContent className="p-4">
                <p className="text-sm text-red-600 dark:text-red-400">Vencido</p>
                <p className="text-2xl font-bold text-red-700 dark:text-red-300">{formatCurrency(receivableBuckets.vencido)}</p>
              </CardContent>
            </Card>
            <Card className="bg-amber-500/10 border-amber-500/30">
              <CardContent className="p-4">
                <p className="text-sm text-amber-600 dark:text-amber-400">0 a 7 dias</p>
                <p className="text-2xl font-bold text-amber-700 dark:text-amber-300">{formatCurrency(receivableBuckets.ate7)}</p>
              </CardContent>
            </Card>
            <Card className="bg-blue-500/10 border-blue-500/30">
              <CardContent className="p-4">
                <p className="text-sm text-blue-600 dark:text-blue-400">8 a 30 dias</p>
                <p className="text-2xl font-bold text-blue-700 dark:text-blue-300">{formatCurrency(receivableBuckets.ate30)}</p>
              </CardContent>
            </Card>
          </div>
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <CardTitle className="text-xl font-semibold">Top 5 pendÃªncias por cliente/parceiro</CardTitle>
        </CardHeader>
        <CardContent>
          {topPendencias.length === 0 ? (
            <p className="text-muted-foreground">Nenhuma pendÃªncia em aberto</p>
          ) : (
            <div className="space-y-3">
              {topPendencias.map((item) => (
                <Card key={item.clientName} className="hover-elevate">
                  <CardContent className="p-4 flex items-center justify-between">
                    <div className="min-w-0">
                      <p className="font-semibold truncate">{item.clientName}</p>
                      <p className="text-xs text-muted-foreground">Aberto</p>
                    </div>
                    <p className="text-xl font-bold text-primary">{formatCurrency(item.total)}</p>
                  </CardContent>
                </Card>
              ))}
            </div>
          )}
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <div>
            <CardTitle className="text-xl font-semibold">Valores a Receber</CardTitle>
            <p className="text-sm text-muted-foreground mt-1">
              Total: R$ {totalReceivables.toLocaleString("pt-BR", { minimumFractionDigits: 2 })}
            </p>
          </div>
        </CardHeader>
        <CardContent>
          <div className="space-y-3">
            {receivables.map((receivable) => {
              const statusInfo = statusConfig[receivable.status];
              return (
                <Card key={receivable.id} className="hover-elevate" data-testid={`card-receivable-${receivable.id}`}>
                  <div className="p-4 flex items-center justify-between">
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-1">
                        <h4 className="font-semibold" data-testid="text-receivable-client">
                          {receivable.clientName}
                        </h4>
                        <Badge variant={statusInfo.variant}>{statusInfo.label}</Badge>
                      </div>
                      <p className="text-sm text-muted-foreground">
                        Vencimento: {receivable.dueDate.toLocaleDateString("pt-BR")}
                      </p>
                    </div>
                    <div className="text-right">
                      <div className="text-2xl font-bold" data-testid="text-receivable-amount">
                        R$ {receivable.amount.toLocaleString("pt-BR", { minimumFractionDigits: 2 })}
                      </div>
                    </div>
                  </div>
                </Card>
              );
            })}
          </div>
        </CardContent>
      </Card>

      <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>
        <DialogContent className="max-w-3xl">
          <DialogHeader>
            <DialogTitle>Chamado CONCLUIDO</DialogTitle>
          </DialogHeader>
          {selectedTicket && renderTicketCard(selectedTicket, true)}
        </DialogContent>
      </Dialog>
    </div>
  );
}
















